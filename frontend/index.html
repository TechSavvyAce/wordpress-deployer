<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WordPress Deployer - Automated Site Deployment</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
      }

      .nav-tabs {
        display: flex;
        background: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
      }

      .nav-tab {
        flex: 1;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        color: #6b7280;
      }

      .nav-tab.active {
        background: white;
        color: #4f46e5;
        border-bottom-color: #4f46e5;
      }

      .nav-tab:hover {
        background: #f3f4f6;
        color: #4f46e5;
      }

      .tab-content {
        display: none;
        padding: 40px 30px;
      }

      .tab-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 0.95rem;
      }

      .form-control {
        width: 100%;
        padding: 15px 18px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f9fafb;
      }

      .form-control:focus {
        outline: none;
        border-color: #4f46e5;
        background: white;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .form-control select {
        cursor: pointer;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .file-input {
        position: absolute;
        left: -9999px;
      }

      .file-input-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 15px 18px;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        background: #f9fafb;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        color: #6b7280;
      }

      .file-input-label:hover {
        border-color: #4f46e5;
        background: #f3f4f6;
        color: #4f46e5;
      }

      .file-input:focus + .file-input-label {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .selected-file {
        margin-top: 10px;
        padding: 10px;
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        border-radius: 8px;
        color: #065f46;
        font-size: 0.9rem;
        display: none;
      }

      .btn {
        padding: 15px 25px;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-decoration: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 2px solid #e5e7eb;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
        border-color: #d1d5db;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-full {
        width: 100%;
      }

      .loading {
        display: none;
      }

      .loading .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .result {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        display: none;
      }

      .result.success {
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        color: #065f46;
      }

      .result.error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
      }

      .result h3 {
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .result pre {
        background: rgba(0, 0, 0, 0.05);
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 0.9rem;
        margin-top: 10px;
      }

      .credentials-list {
        margin-top: 20px;
      }

      .credential-item {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
      }

      .credential-info h4 {
        color: #374151;
        margin-bottom: 5px;
        font-size: 1.1rem;
      }

      .credential-info p {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 5px 0;
      }

      .credential-actions {
        display: flex;
        gap: 10px;
      }

      .jobs-list {
        margin-top: 20px;
      }

      .job-item {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
      }

      .job-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .job-title {
        font-weight: 600;
        color: #374151;
        font-size: 1.1rem;
      }

      .job-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .job-status.created {
        background: #dbeafe;
        color: #1e40af;
      }

      .job-status.uploading {
        background: #fef3c7;
        color: #d97706;
      }

      .job-status.uploaded {
        background: #d1fae5;
        color: #065f46;
      }

      .job-status.failed {
        background: #fee2e2;
        color: #991b1b;
      }

      .job-details {
        color: #6b7280;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .templates-list {
        margin-top: 20px;
      }

      .template-item {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .template-info h4 {
        color: #374151;
        margin-bottom: 5px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .template-info p {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 5px 0;
      }

      .template-type {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .template-type.custom {
        background: #dbeafe;
        color: #1e40af;
      }

      .template-type.wordpress {
        background: #d1fae5;
        color: #065f46;
      }

      .template-actions {
        display: flex;
        gap: 10px;
      }

      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 30px;
        padding: 30px;
        background: #f8fafc;
        border-top: 1px solid #e5e7eb;
      }

      .feature {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .feature i {
        font-size: 2rem;
        color: #4f46e5;
        margin-bottom: 10px;
      }

      .feature h4 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #374151;
      }

      .feature p {
        font-size: 0.85rem;
        color: #6b7280;
        line-height: 1.4;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .credential-selector {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .credential-selector select {
        flex: 1;
      }

      .credential-selector .btn {
        white-space: nowrap;
        padding: 15px 18px;
      }

      .credential-info {
        margin-top: 15px;
        padding: 10px 20px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 12px;
        color: #0c4a6e;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .credential-info-header {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .credential-info-header.validating {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }

      .credential-info-header.valid {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .credential-info-header.invalid {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .credential-info-header.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .credential-info-header i {
        font-size: 1.1rem;
      }

      .credential-info-content {
        padding: 20px;
      }

      .credential-info-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px 0;
        border-bottom: 1px solid #e0f2fe;
      }

      .credential-info-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .credential-info-item i {
        width: 20px;
        color: #0ea5e9;
        font-size: 1rem;
      }

      .credential-info-item div {
        flex: 1;
      }

      .credential-info-item label {
        display: block;
        font-size: 0.8rem;
        font-weight: 600;
        color: #0369a1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .credential-info-item span {
        display: block;
        font-size: 1rem;
        font-weight: 500;
        color: #0c4a6e;
      }

      /* Inline validation status */
      .validation-status {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
      }

      .loading-overlay-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .loading-overlay .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      .loading-overlay h3 {
        color: #374151;
        margin-bottom: 10px;
      }

      .loading-overlay p {
        color: #6b7280;
        font-size: 0.9rem;
      }

      /* Toast Notification System */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        pointer-events: none;
      }

      .toast {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 16px 20px;
        margin-bottom: 10px;
        min-width: 300px;
        max-width: 400px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        pointer-events: auto;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
        border-left: 4px solid #e5e7eb;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        border-left-color: #10b981;
      }

      .toast.error {
        border-left-color: #ef4444;
      }

      .toast.warning {
        border-left-color: #f59e0b;
      }

      .toast.info {
        border-left-color: #3b82f6;
      }

      .toast-icon {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 12px;
      }

      .toast.success .toast-icon {
        background: #d1fae5;
        color: #065f46;
      }

      .toast.error .toast-icon {
        background: #fee2e2;
        color: #991b1b;
      }

      .toast.warning .toast-icon {
        background: #fef3c7;
        color: #d97706;
      }

      .toast.info .toast-icon {
        background: #dbeafe;
        color: #1e40af;
      }

      .toast-content {
        flex: 1;
        min-width: 0;
      }

      .toast-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: #374151;
      }

      .toast-message {
        font-size: 0.85rem;
        color: #6b7280;
        line-height: 1.4;
      }

      .toast-close {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .toast-close:hover {
        background: #f3f4f6;
        color: #6b7280;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          border-radius: 15px;
          max-width: 100%;
        }

        .header {
          padding: 30px 20px;
        }

        .header h1 {
          font-size: 2rem;
          flex-direction: column;
          gap: 10px;
        }

        .tab-content {
          padding: 30px 20px;
        }

        .nav-tabs {
          flex-direction: column;
        }

        .nav-tab {
          border-bottom: none;
          border-right: 3px solid transparent;
        }

        .nav-tab.active {
          border-right-color: #4f46e5;
          border-bottom-color: transparent;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .credential-item {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .credential-actions {
          justify-content: center;
        }

        .features {
          grid-template-columns: 1fr;
          padding: 20px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.8rem;
        }

        .form-control {
          padding: 12px 15px;
        }

        .btn {
          padding: 12px 20px;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-rocket"></i>
          WordPress Deployer
        </h1>
        <p>Automated WordPress site deployment for your new domains</p>
      </div>

      <div class="nav-tabs">
        <div class="nav-tab active" data-tab="deploy">
          <i class="fas fa-rocket"></i> Deploy Site
        </div>
        <!-- Credentials, Templates, and Jobs tabs removed -->
      </div>

      <!-- Deploy Tab -->
      <div class="tab-content active" id="deploy-tab">
        <form
          id="deployForm"
          action="http://localhost:3001/deploy"
          method="POST"
          enctype="multipart/form-data"
        >
          <div class="form-group">
            <label for="template">
              <i class="fas fa-palette"></i> Choose Template
            </label>
            <select name="template" id="template" class="form-control" required>
              <option value="">Loading templates...</option>
            </select>
          </div>

          <!-- Credential Inputs -->
          <div class="form-group">
            <label for="credentialHost">
              <i class="fas fa-server"></i> cPanel Host
            </label>
            <input
              type="text"
              name="credentialHost"
              id="credentialHost"
              class="form-control"
              placeholder="mydomain.com or server IP"
              required
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="credentialUsername">
                <i class="fas fa-user"></i> cPanel Username
              </label>
              <input
                type="text"
                name="credentialUsername"
                id="credentialUsername"
                class="form-control"
                placeholder="cpanel_username"
                required
              />
            </div>
            <div class="form-group">
              <label for="credentialPassword">
                <i class="fas fa-lock"></i> cPanel Password
              </label>
              <input
                type="password"
                name="credentialPassword"
                id="credentialPassword"
                class="form-control"
                placeholder="cpanel_password"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label for="credentialPort">
              <i class="fas fa-network-wired"></i> cPanel Port
            </label>
            <input
              type="number"
              name="credentialPort"
              id="credentialPort"
              class="form-control"
              value="2083"
              placeholder="2083"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="title"> <i class="fas fa-envelope"></i> Title </label>
              <input
                type="text"
                name="title"
                id="title"
                class="form-control"
                placeholder="Your Business Name"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="email">
                <i class="fas fa-envelope"></i> Admin Email
              </label>
              <input
                type="email"
                name="email"
                id="email"
                class="form-control"
                placeholder="admin@yourdomain.com"
                required
              />
            </div>

            <div class="form-group">
              <label for="phone">
                <i class="fas fa-phone"></i> Contact Phone
              </label>
              <input
                type="tel"
                name="phone"
                id="phone"
                class="form-control"
                placeholder="+1 (555) 123-4567"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="address">
              <i class="fas fa-map-marker-alt"></i> Business Address
            </label>
            <input
              type="text"
              name="address"
              id="address"
              class="form-control"
              placeholder="123 Main St, City, State 12345"
              required
            />
          </div>

          <div class="form-group">
            <label> <i class="fas fa-image"></i> Upload Logo </label>
            <div class="file-input-wrapper">
              <input
                type="file"
                name="logo"
                id="logo"
                class="file-input"
                accept="image/*"
                required
              />
              <label for="logo" class="file-input-label">
                <i class="fas fa-cloud-upload-alt"></i>
                <span id="fileLabel">Choose logo file or drag here</span>
              </label>
            </div>
            <div id="selectedFile" class="selected-file"></div>
          </div>

          <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
            <span class="btn-text">
              <i class="fas fa-rocket"></i>
              Deploy WordPress Site
            </span>
            <span class="loading">
              <div class="spinner"></div>
              Deploying...
            </span>
          </button>
        </form>
      </div>

      <!-- Credentials Tab -->
      <div class="tab-content" id="credentials-tab">
        <div class="form-group">
          <h3><i class="fas fa-plus"></i> Add New Credentials</h3>
          <form id="credentialForm">
            <div class="form-row">
              <div class="form-group">
                <label for="credentialName">
                  <i class="fas fa-tag"></i> Credential Name
                </label>
                <input
                  type="text"
                  id="credentialName"
                  class="form-control"
                  placeholder="My Hosting Account"
                  required
                />
              </div>
              <div class="form-group">
                <label for="credentialHost">
                  <i class="fas fa-server"></i> cPanel Host
                </label>
                <input
                  type="text"
                  id="credentialHost"
                  class="form-control"
                  placeholder="mydomain.com or server IP"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="credentialUsername">
                  <i class="fas fa-user"></i> cPanel Username
                </label>
                <input
                  type="text"
                  id="credentialUsername"
                  class="form-control"
                  placeholder="cpanel_username"
                  required
                />
              </div>
              <div class="form-group">
                <label for="credentialPassword">
                  <i class="fas fa-lock"></i> cPanel Password
                </label>
                <input
                  type="password"
                  id="credentialPassword"
                  class="form-control"
                  placeholder="cpanel_password"
                  required
                />
              </div>
            </div>

            <div class="form-group">
              <label for="credentialPort">
                <i class="fas fa-network-wired"></i> cPanel Port
              </label>
              <input
                type="number"
                id="credentialPort"
                class="form-control"
                value="2083"
                placeholder="2083"
              />
            </div>

            <div class="form-group">
              <button type="submit" class="btn btn-primary" id="validateBtn">
                <span class="btn-text">
                  <i class="fas fa-check"></i>
                  Validate & Save Credentials
                </span>
                <span class="loading">
                  <div class="spinner"></div>
                  Validating...
                </span>
              </button>
            </div>
          </form>
        </div>

        <div id="credentialResult" class="result"></div>
        <div id="credentialsList" class="credentials-list"></div>
      </div>

      <!-- Jobs Tab -->
      <div class="tab-content" id="jobs-tab">
        <div class="form-group">
          <h3><i class="fas fa-list"></i> Deployment Jobs</h3>
          <button class="btn btn-secondary" onclick="loadJobs()">
            <i class="fas fa-refresh"></i> Refresh Jobs
          </button>
        </div>
        <div id="jobsList" class="jobs-list"></div>
      </div>

      <!-- Templates Tab -->
      <div class="tab-content" id="templates-tab">
        <div class="form-group">
          <h3><i class="fas fa-upload"></i> Upload Custom Template</h3>
          <form id="templateForm" enctype="multipart/form-data">
            <div class="form-group">
              <label for="templateFile">
                <i class="fas fa-file-archive"></i> Select .wpress Template File
              </label>
              <div class="file-input-wrapper">
                <input
                  type="file"
                  name="template"
                  id="templateFile"
                  class="file-input"
                  accept=".wpress"
                  required
                />
                <label for="templateFile" class="file-input-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span id="templateFileLabel"
                    >Choose .wpress file or drag here</span
                  >
                </label>
              </div>
              <div id="selectedTemplateFile" class="selected-file"></div>
            </div>

            <button
              type="submit"
              class="btn btn-primary"
              id="uploadTemplateBtn"
            >
              <span class="btn-text">
                <i class="fas fa-upload"></i>
                Upload Template
              </span>
              <span class="loading">
                <div class="spinner"></div>
                Uploading...
              </span>
            </button>
          </form>
        </div>

        <div id="templateResult" class="result"></div>

        <div class="form-group">
          <h3><i class="fas fa-palette"></i> Available Templates</h3>
          <button
            class="btn btn-secondary"
            onclick="loadTemplatesForManagement()"
          >
            <i class="fas fa-refresh"></i> Refresh Templates
          </button>
        </div>
        <div id="templatesList" class="templates-list"></div>
      </div>

      <div class="features">
        <div class="feature">
          <i class="fas fa-bolt"></i>
          <h4>Fast Deployment</h4>
          <p>Deploy WordPress sites in minutes, not hours</p>
        </div>
        <div class="feature">
          <i class="fas fa-mobile-alt"></i>
          <h4>Mobile Ready</h4>
          <p>All templates are fully responsive</p>
        </div>
        <div class="feature">
          <i class="fas fa-shield-alt"></i>
          <h4>Secure</h4>
          <p>Built with security best practices</p>
        </div>
        <div class="feature">
          <i class="fas fa-cogs"></i>
          <h4>Automated</h4>
          <p>One-click deployment process</p>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let savedCredentials = [];
      let selectedCredential = null;

      // Load templates from backend
      async function loadTemplates() {
        try {
          const response = await fetch("http://localhost:3001/templates");
          const data = await response.json();

          const templateSelect = document.getElementById("template");
          const currentSelection = templateSelect.value; // Preserve current selection

          templateSelect.innerHTML =
            '<option value="">Select a template...</option>';

          if (data.templates && data.templates.length > 0) {
            data.templates.forEach((template) => {
              const option = document.createElement("option");
              option.value = template.id;

              // Create a more informative display with template type and details
              let displayText = "";

              if (template.type === "custom") {
                // Custom template display
                displayText = `🎨 ${template.name}`;
                if (template.sizeFormatted) {
                  displayText += ` (${template.sizeFormatted})`;
                }
                displayText += ` - Custom Template`;
              } else {
                // WordPress.org theme display
                displayText = `🌐 ${template.name}`;
                if (template.rating) {
                  displayText += ` ⭐ ${template.rating}`;
                }
                if (template.version) {
                  displayText += ` (v${template.version})`;
                }
                if (template.num_ratings) {
                  displayText += ` (${template.num_ratings} reviews)`;
                }
                displayText += ` - WordPress.org`;
              }

              option.textContent = displayText;
              option.title = template.description || template.name;
              templateSelect.appendChild(option);
            });
          } else {
            templateSelect.innerHTML =
              '<option value="">No templates available</option>';
          }

          // Restore the previous selection if it still exists
          if (currentSelection) {
            const stillExists = data.templates?.find(
              (t) => t.id === currentSelection
            );
            if (stillExists) {
              templateSelect.value = currentSelection;
            }
          }
        } catch (error) {
          console.error("Error loading templates:", error);
          const templateSelect = document.getElementById("template");
          templateSelect.innerHTML =
            '<option value="">Error loading templates</option>';
        }
      }

      // Tab switching
      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          // Remove active class from all tabs and contents
          document
            .querySelectorAll(".nav-tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          // Add active class to clicked tab
          tab.classList.add("active");
          document
            .getElementById(tab.dataset.tab + "-tab")
            .classList.add("active");

          // Clean up validation logs when switching tabs
          const existingLogs = document.querySelectorAll(".validation-logs");
          existingLogs.forEach((log) => log.remove());

          // Load data for the tab
          if (tab.dataset.tab === "deploy") {
            loadTemplates();
          }
        });
      });

      // File input handling
      const fileInput = document.getElementById("logo");
      const fileLabel = document.getElementById("fileLabel");
      const selectedFile = document.getElementById("selectedFile");

      fileInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          fileLabel.textContent = file.name;
          selectedFile.textContent = `Selected: ${file.name} (${(
            file.size / 1024
          ).toFixed(1)} KB)`;
          selectedFile.style.display = "block";
        } else {
          fileLabel.textContent = "Choose logo file or drag here";
          selectedFile.style.display = "none";
        }
      });

      // Template file input handling
      const templateFileInput = document.getElementById("templateFile");
      const templateFileLabel = document.getElementById("templateFileLabel");
      const selectedTemplateFile = document.getElementById(
        "selectedTemplateFile"
      );

      templateFileInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          templateFileLabel.textContent = file.name;
          selectedTemplateFile.textContent = `Selected: ${file.name} (${(
            file.size /
            (1024 * 1024)
          ).toFixed(1)} MB)`;
          selectedTemplateFile.style.display = "block";
        } else {
          templateFileLabel.textContent = "Choose .wpress file or drag here";
          selectedTemplateFile.style.display = "none";
        }
      });

      // Drag and drop functionality
      const fileInputLabel = document.querySelector(".file-input-label");

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        fileInputLabel.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        fileInputLabel.addEventListener(eventName, highlight, false);
      });

      ["dragleave", "drop"].forEach((eventName) => {
        fileInputLabel.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e) {
        fileInputLabel.style.borderColor = "#4f46e5";
        fileInputLabel.style.background = "#f3f4f6";
      }

      function unhighlight(e) {
        fileInputLabel.style.borderColor = "#d1d5db";
        fileInputLabel.style.background = "#f9fafb";
      }

      fileInputLabel.addEventListener("drop", handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        fileInput.dispatchEvent(new Event("change"));
      }

      // Form submission - Updated for new workflow
      const form = document.getElementById("deployForm");
      const submitBtn = document.getElementById("submitBtn");
      const btnText = submitBtn.querySelector(".btn-text");
      const loading = submitBtn.querySelector(".loading");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Gather credential data from inputs
        const credentialData = {
          host: document.getElementById("credentialHost").value.trim(),
          username: document.getElementById("credentialUsername").value.trim(),
          password: document.getElementById("credentialPassword").value,
          port:
            parseInt(document.getElementById("credentialPort").value) || 2083,
        };

        // Show loading state
        submitBtn.disabled = true;
        btnText.style.display = "none";
        loading.style.display = "flex";

        try {
          // 1. Validate credentials
          const validateResponse = await fetch(
            "http://localhost:3001/validate-credentials-stream",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(credentialData),
            }
          );

          // Handle streaming response (optional: show logs)
          let validationResult = null;
          if (validateResponse.body && validateResponse.ok) {
            const reader = validateResponse.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value);
              const lines = chunk.split("\n");
              for (const line of lines) {
                if (line.startsWith("data: ")) {
                  try {
                    const data = JSON.parse(line.slice(6));
                    if (data.type === "success")
                      validationResult = { success: true, ...data };
                    if (data.type === "error")
                      validationResult = { success: false, ...data };
                  } catch {}
                }
              }
            }
          }

          if (!validationResult || !validationResult.success) {
            showErrorToast(
              validationResult?.message ||
                "Invalid credentials. Please check and try again."
            );
            submitBtn.disabled = false;
            btnText.style.display = "flex";
            loading.style.display = "none";
            return;
          }

          // 2. Save credentials
          const saveResponse = await fetch(
            "http://localhost:3001/save-credentials",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(credentialData),
            }
          );
          const saveData = await saveResponse.json();
          if (!saveResponse.ok || !saveData.credentialId) {
            showErrorToast("Failed to save credentials. Please try again.");
            submitBtn.disabled = false;
            btnText.style.display = "flex";
            loading.style.display = "none";
            return;
          }

          // 3. Proceed with deployment using credentialId
          const formData = new FormData(form);
          formData.append("credentialId", saveData.credentialId);
          formData.append("domain", credentialData.host); // Use host as domain

          const jobResponse = await fetch(form.action, {
            method: "POST",
            body: formData,
          });

          const jobData = await jobResponse.json();

          if (jobResponse.ok) {
            // Then immediately deploy using the selected credentials with streaming logs
            const deployWithStreaming = async () => {
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minute timeout

              try {
                const response = await fetch(
                  `http://localhost:3001/upload/${jobData.jobId}/stream`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      credentialId: saveData.credentialId,
                    }),
                    signal: controller.signal,
                  }
                );

                clearTimeout(timeoutId);
                if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                // Handle streaming response (reuse previous logic)
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let deploymentResult = null;
                let logs = [];
                let logContainer = document.querySelector(".deployment-logs");
                if (!logContainer) {
                  logContainer = document.createElement("div");
                  logContainer.className = "deployment-logs";
                  logContainer.style.cssText = `
                    background: #f8fafc;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 15px 0;
                    max-height: 400px;
                    overflow-y: auto;
                    font-family: monospace;
                    font-size: 0.9rem;
                    line-height: 1.4;
                  `;
                  const logTitle = document.createElement("div");
                  logTitle.innerHTML =
                    "<strong>🚀 Deployment Progress:</strong>";
                  logTitle.style.marginBottom = "10px";
                  logContainer.appendChild(logTitle);
                  const progressContainer = document.createElement("div");
                  progressContainer.style.cssText = `
                    margin-bottom: 10px;
                    background: #e5e7eb;
                    border-radius: 10px;
                    overflow: hidden;
                    height: 8px;
                  `;
                  const progressBar = document.createElement("div");
                  progressBar.id = "deploymentProgressBar";
                  progressBar.style.cssText = `
                    background: linear-gradient(90deg, #4f46e5, #7c3aed);
                    height: 100%;
                    width: 0%;
                    transition: width 0.3s ease;
                  `;
                  progressContainer.appendChild(progressBar);
                  logContainer.appendChild(progressContainer);
                  const logContent = document.createElement("div");
                  logContent.id = "deploymentLogContent";
                  logContainer.appendChild(logContent);
                  const deploymentTab = document.getElementById("deploy-tab");
                  deploymentTab.appendChild(logContainer);
                } else {
                  const logContent = logContainer.querySelector(
                    "#deploymentLogContent"
                  );
                  if (logContent) logContent.innerHTML = "";
                  const logTitle = logContainer.querySelector("div");
                  if (logTitle)
                    logTitle.innerHTML =
                      "<strong>🚀 Deployment Progress:</strong>";
                  const progressBar = logContainer.querySelector(
                    "#deploymentProgressBar"
                  );
                  if (progressBar) progressBar.style.width = "0%";
                }
                const logContent = logContainer.querySelector(
                  "#deploymentLogContent"
                );
                try {
                  while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");
                    for (const line of lines) {
                      if (line.startsWith("data: ")) {
                        try {
                          const data = JSON.parse(line.slice(6));
                          if (data.type === "start") {
                            logContent.innerHTML += `<div style="margin: 2px 0; color: #1f2937; font-weight: bold;">🚀 ${data.message}</div>`;
                            const progressBar = logContainer.querySelector(
                              "#deploymentProgressBar"
                            );
                            if (progressBar) progressBar.style.width = "10%";
                          } else if (data.type === "log") {
                            logs.push(data.message);
                            logContent.innerHTML += `<div style="margin: 2px 0; color: #374151;">${data.message}</div>`;
                            const progressBar = logContainer.querySelector(
                              "#deploymentProgressBar"
                            );
                            if (progressBar) {
                              if (
                                data.message.includes(
                                  "MySQL database and user created"
                                )
                              )
                                progressBar.style.width = "30%";
                              else if (
                                data.message.includes(
                                  "FTP credentials retrieved"
                                )
                              )
                                progressBar.style.width = "50%";
                              else if (
                                data.message.includes(
                                  "WordPress core files uploaded"
                                )
                              )
                                progressBar.style.width = "70%";
                              else if (
                                data.message.includes("Template uploaded")
                              )
                                progressBar.style.width = "80%";
                              else if (data.message.includes("Logo uploaded"))
                                progressBar.style.width = "85%";
                              else if (
                                data.message.includes("Install script uploaded")
                              )
                                progressBar.style.width = "90%";
                              else if (data.message.includes("plugin uploaded"))
                                progressBar.style.width = "95%";
                            }
                          } else if (data.type === "info") {
                            logContent.innerHTML += `<div style="margin: 2px 0; color: #1d4ed8;">ℹ️ ${data.message}</div>`;
                          } else if (data.type === "success") {
                            deploymentResult = { success: true, ...data };
                            logContent.innerHTML += `<div style="margin: 2px 0; color: #065f46; font-weight: bold;">✅ ${data.message}</div>`;
                            const progressBar = logContainer.querySelector(
                              "#deploymentProgressBar"
                            );
                            if (progressBar) progressBar.style.width = "100%";
                          } else if (data.type === "error") {
                            deploymentResult = { success: false, ...data };
                            logContent.innerHTML += `<div style="margin: 2px 0; color: #991b1b; font-weight: bold;">❌ ${data.message}</div>`;
                            const progressBar = logContainer.querySelector(
                              "#deploymentProgressBar"
                            );
                            if (progressBar) {
                              progressBar.style.background = "#dc2626";
                              progressBar.style.width = "100%";
                            }
                          }
                          logContainer.scrollTop = logContainer.scrollHeight;
                        } catch (e) {
                          logContent.innerHTML += `<div style="margin: 2px 0; color: #991b1b;">❌ Error parsing log: ${e.message}</div>`;
                          if (!deploymentResult)
                            deploymentResult = {
                              success: false,
                              error: e.message,
                            };
                        }
                      }
                    }
                  }
                } catch (readError) {
                  logContent.innerHTML += `<div style="margin: 2px 0; color: #991b1b;">❌ Stream read error: ${readError.message}</div>`;
                  if (!deploymentResult)
                    deploymentResult = {
                      success: false,
                      error: readError.message,
                    };
                } finally {
                  reader.releaseLock();
                }
                if (!deploymentResult)
                  throw new Error("No deployment result received");
                return {
                  ok: deploymentResult.success,
                  json: () => Promise.resolve(deploymentResult),
                };
              } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === "AbortError") {
                  throw new Error(
                    "Deployment timeout - server took too long to respond"
                  );
                }
                throw error;
              }
            };
            const deployResponse = await deployWithStreaming();
            const deployData = await deployResponse.json();
            if (deployResponse.ok) {
              showSuccessToast("Deployment completed successfully!");
              showNextSteps({
                domain: jobData.domain || credentialData.host,
                manualDbSetup: deployData.manualDbSetup,
                dbInstructions: deployData.dbInstructions,
                nextStep: deployData.nextStep,
              });
            } else {
              showErrorToast(
                "Deployment failed. Please check the deployment logs below."
              );
            }
          } else {
            showErrorToast("Failed to create deployment job.");
          }
        } catch (error) {
          showErrorToast(
            "Network error occurred. Please check your connection."
          );
        } finally {
          submitBtn.disabled = false;
          btnText.style.display = "flex";
          loading.style.display = "none";
        }
      });

      // Credential form handling (in modal)
      const credentialForm = document.getElementById("credentialForm");
      const validateBtn = document.getElementById("validateBtn");
      const validateBtnText = validateBtn.querySelector(".btn-text");
      const validateLoading = validateBtn.querySelector(".loading");

      credentialForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Show loading state
        validateBtn.disabled = true;
        validateBtnText.style.display = "none";
        validateLoading.style.display = "flex";

        try {
          const credentialData = {
            name: document.getElementById("credentialName").value,
            host: document.getElementById("credentialHost").value,
            username: document.getElementById("credentialUsername").value,
            password: document.getElementById("credentialPassword").value,
            port:
              parseInt(document.getElementById("credentialPort").value) || 2083,
          };

          // First validate credentials with streaming logs
          const validateWithStreaming = async () => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout

            try {
              const response = await fetch(
                "http://localhost:3001/validate-credentials-stream",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(credentialData),
                  signal: controller.signal,
                }
              );

              clearTimeout(timeoutId);

              // Handle streaming response
              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let validationResult = null;
              let logs = [];

              // Get or create log display
              let logContainer = document.querySelector(".validation-logs");
              if (!logContainer) {
                logContainer = document.createElement("div");
                logContainer.className = "validation-logs";
                logContainer.style.cssText = `
                  background: #f8fafc;
                  border: 1px solid #e5e7eb;
                  border-radius: 8px;
                  padding: 15px;
                  margin: 15px 0;
                  max-height: 200px;
                  overflow-y: auto;
                  font-family: monospace;
                  font-size: 0.9rem;
                  line-height: 1.4;
                `;

                const logTitle = document.createElement("div");
                logTitle.innerHTML = "<strong>🔍 Validation Progress:</strong>";
                logTitle.style.marginBottom = "10px";
                logContainer.appendChild(logTitle);

                const logContent = document.createElement("div");
                logContent.id = "validationLogContent";
                logContainer.appendChild(logContent);

                // Insert log container before the result div
                const resultDiv = document.getElementById("credentialResult");
                resultDiv.parentNode.insertBefore(logContainer, resultDiv);
              } else {
                // Clear existing logs and update title
                const logContent = logContainer.querySelector(
                  "#validationLogContent"
                );
                if (logContent) {
                  logContent.innerHTML = "";
                }
                const logTitle = logContainer.querySelector("div");
                if (logTitle) {
                  logTitle.innerHTML =
                    "<strong>🔍 Validation Progress:</strong>";
                }
              }

              const logContent = logContainer.querySelector(
                "#validationLogContent"
              );

              try {
                while (true) {
                  const { done, value } = await reader.read();
                  if (done) break;

                  const chunk = decoder.decode(value);
                  const lines = chunk.split("\n");

                  for (const line of lines) {
                    if (line.startsWith("data: ")) {
                      try {
                        const data = JSON.parse(line.slice(6));

                        if (data.type === "log") {
                          logs.push(data.message);
                          logContent.innerHTML += `<div style="margin: 2px 0; color: #374151;">${data.message}</div>`;
                          logContainer.scrollTop = logContainer.scrollHeight;
                        } else if (data.type === "success") {
                          validationResult = { success: true, ...data };
                          logContent.innerHTML += `<div style="margin: 2px 0; color: #065f46; font-weight: bold;">✅ ${data.message}</div>`;
                        } else if (data.type === "error") {
                          validationResult = { success: false, ...data };
                          logContent.innerHTML += `<div style="margin: 2px 0; color: #991b1b; font-weight: bold;">❌ ${data.message}</div>`;
                        }
                      } catch (e) {
                        console.error("Error parsing SSE data:", e);
                      }
                    }
                  }
                }
              } finally {
                reader.releaseLock();
              }

              if (!validationResult) {
                throw new Error("No validation result received");
              }

              return {
                ok: validationResult.success,
                json: () => Promise.resolve(validationResult),
              };
            } catch (error) {
              clearTimeout(timeoutId);
              if (error.name === "AbortError") {
                throw new Error(
                  "Validation timeout - server took too long to respond"
                );
              }
              throw error;
            }
          };

          const validateResponse = await validateWithStreaming();
          const validateData = await validateResponse.json();

          if (validateResponse.ok && validateData.success) {
            // Save credentials
            const saveResponse = await fetch(
              "http://localhost:3001/save-credentials",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(credentialData),
              }
            );

            const saveData = await saveResponse.json();

            if (saveResponse.ok) {
              showCredentialResult(
                "success",
                "Credentials Saved Successfully!",
                saveData
              );
              showSuccessToast("Credentials saved successfully!");
              credentialForm.reset();
              loadCredentials(); // Refresh the credentials tab

              // Auto-switch back to deploy tab after 2 seconds
              setTimeout(() => {
                document
                  .querySelectorAll(".nav-tab")
                  .forEach((t) => t.classList.remove("active"));
                document
                  .querySelectorAll(".tab-content")
                  .forEach((c) => c.classList.remove("active"));
                document
                  .querySelector('[data-tab="deploy"]')
                  .classList.add("active");
                document.getElementById("deploy-tab").classList.add("active");
              }, 2000);
            } else {
              showCredentialResult(
                "error",
                "Failed to Save Credentials",
                saveData
              );
            }
          } else {
            console.error("Credential validation error:", validateData);

            let errorMessage = "Network Error";
            let errorDetails = validateData.error || validateData.message;

            if (validateData.error && validateData.error.includes("timeout")) {
              errorMessage = "Validation Timeout";
              errorDetails =
                "The server took too long to respond. This could mean:\n" +
                "• The hosting server is slow or overloaded\n" +
                "• Network connection issues\n" +
                "• The credentials might be invalid\n\n" +
                "You can try again or check your credentials.";
            } else if (
              validateData.error &&
              validateData.error.includes("Failed to fetch")
            ) {
              errorMessage = "Connection Error";
              errorDetails =
                "Cannot connect to the validation server. Please check your internet connection.";
            }

            showCredentialResult("error", errorMessage, {
              error: errorDetails,
              suggestion:
                "Please check your credentials and try again, or contact your hosting provider if the issue persists.",
            });
          }
        } catch (error) {
          console.error("Credential validation error:", error);

          let errorMessage = "Network Error";
          let errorDetails = error.message;

          if (error.message.includes("timeout")) {
            errorMessage = "Validation Timeout";
            errorDetails =
              "The server took too long to respond. This could mean:\n" +
              "• The hosting server is slow or overloaded\n" +
              "• Network connection issues\n" +
              "• The credentials might be invalid\n\n" +
              "You can try again or check your credentials.";
          } else if (error.message.includes("Failed to fetch")) {
            errorMessage = "Connection Error";
            errorDetails =
              "Cannot connect to the validation server. Please check your internet connection.";
          }

          showCredentialResult("error", errorMessage, {
            error: errorDetails,
            suggestion:
              "Please check your credentials and try again, or contact your hosting provider if the issue persists.",
          });
        } finally {
          // Reset button state
          validateBtn.disabled = false;
          validateBtnText.style.display = "flex";
          validateLoading.style.display = "none";
        }
      });

      function showCredentialResult(type, title, data) {
        const credentialResult = document.getElementById("credentialResult");
        credentialResult.className = `result ${type}`;
        credentialResult.innerHTML = `
              <h3><i class="fas fa-${
                type === "success" ? "check-circle" : "exclamation-circle"
              }"></i> ${title}</h3>
              <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        credentialResult.style.display = "block";
        credentialResult.scrollIntoView({ behavior: "smooth" });
      }

      // Load credentials for credentials tab
      async function loadCredentials() {
        try {
          const response = await fetch("http://localhost:3001/credentials");
          const data = await response.json();

          const credentialsList = document.getElementById("credentialsList");

          if (data.credentials.length === 0) {
            credentialsList.innerHTML =
              '<p style="text-align: center; color: #6b7280; padding: 20px;">No saved credentials found.</p>';
            return;
          }

          credentialsList.innerHTML = data.credentials
            .map(
              (cred) => `
            <div class="credential-item">
              <div class="credential-info">
                <h4>${cred.name}</h4>
                <p><strong>Host:</strong> ${cred.host}</p>
                <p><strong>Username:</strong> ${cred.username}</p>
                <p><strong>Validated:</strong> ${new Date(
                  cred.validatedAt
                ).toLocaleDateString()}</p>
                ${
                  cred.lastUsed
                    ? `<p><strong>Last Used:</strong> ${new Date(
                        cred.lastUsed
                      ).toLocaleDateString()}</p>`
                    : ""
                }
              </div>
              <div class="credential-actions">
                <button class="btn btn-danger" onclick="deleteCredential('${
                  cred.id
                }')">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading credentials:", error);
        }
      }

      // Delete credential
      async function deleteCredential(id) {
        showConfirmDialog(
          "Delete Credential",
          "Are you sure you want to delete this credential?",
          () => performDeleteCredential(id)
        );
      }

      async function performDeleteCredential(id) {
        try {
          const response = await fetch(
            `http://localhost:3001/credentials/${id}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            // Refresh both tabs
            loadCredentials(); // Refresh the credentials tab

            // Show success message if we're on the credentials tab
            const credentialsTab = document.getElementById("credentials-tab");
            if (credentialsTab.classList.contains("active")) {
              showCredentialResult(
                "success",
                "Credential Deleted Successfully!",
                {
                  message:
                    "The credential has been removed from your saved list",
                }
              );
            }
            showSuccessToast("Credential deleted successfully!");
          } else {
            showErrorToast("Failed to delete credential");
          }
        } catch (error) {
          console.error("Error deleting credential:", error);
          showErrorToast("Error deleting credential");
        }
      }

      // Remove invalid credential from error message
      async function removeInvalidCredential(id, name) {
        showConfirmDialog(
          "Remove Invalid Credential",
          `Are you sure you want to remove "${name}" from your saved credentials?`,
          () => performRemoveInvalidCredential(id, name)
        );
      }

      async function performRemoveInvalidCredential(id, name) {
        try {
          const response = await fetch(
            `http://localhost:3001/credentials/${id}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            // Refresh both tabs
            loadCredentials(); // Refresh the credentials tab

            // Show success message
            showSuccessToast(`"${name}" removed from saved credentials`);
          } else {
            showErrorToast("Failed to remove credential");
          }
        } catch (error) {
          console.error("Error removing credential:", error);
          showErrorToast("Error removing credential");
        }
      }

      // Use credential anyway (skip validation)
      function useCredentialAnyway() {
        // Get the credential that was being validated
        const credentialSelect = document.getElementById("credentialSelect");
        const credentialId = credentialSelect.value;

        if (credentialId) {
          selectedCredential = savedCredentials.find(
            (c) => c.id === credentialId
          );
          if (selectedCredential) {
            // Set up the credential info display
            document.getElementById("selectedDomain").textContent =
              selectedCredential.host;
            document.getElementById("selectedHost").textContent =
              selectedCredential.host;
            document.getElementById("credentialInfo").style.display = "block";

            // Auto-fill email with domain
            const emailInput = document.getElementById("email");
            if (!emailInput.value) {
              emailInput.placeholder = `admin@${selectedCredential.host}`;
            }

            showWarningToast(
              `Using "${selectedCredential.name}" without validation`
            );
          }
        }
      }

      // Load jobs
      async function loadJobs() {
        try {
          const response = await fetch("http://localhost:3001/jobs");
          const data = await response.json();

          const jobsList = document.getElementById("jobsList");

          if (data.jobs.length === 0) {
            jobsList.innerHTML =
              '<p style="text-align: center; color: #6b7280; padding: 20px;">No deployment jobs found.</p>';
            return;
          }

          jobsList.innerHTML = data.jobs
            .map(
              (job) => `
            <div class="job-item">
              <div class="job-header">
                <div class="job-title">${job.domain}</div>
                <div class="job-status ${
                  job.status
                }">${job.status.toUpperCase()}</div>
              </div>
              <div class="job-details">
                <p><strong>Template:</strong> ${job.template}</p>
                <p><strong>Created:</strong> ${new Date(
                  job.timestamp
                ).toLocaleString()}</p>
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading jobs:", error);
        }
      }

      // Tab switching function for "Add New" button
      function switchToCredentialsTab() {
        // Remove active class from all tabs and contents
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        // Add active class to credentials tab
        document
          .querySelector('[data-tab="credentials"]')
          .classList.add("active");
        document.getElementById("credentials-tab").classList.add("active");

        // Load credentials data
        loadCredentials();
      }

      // Form validation
      const inputs = form.querySelectorAll("input, select");
      inputs.forEach((input) => {
        input.addEventListener("blur", validateField);
        input.addEventListener("input", clearError);
      });

      function validateField(e) {
        const field = e.target;
        if (field.hasAttribute("required") && !field.value.trim()) {
          field.style.borderColor = "#ef4444";
        } else {
          field.style.borderColor = "#e5e7eb";
        }
      }

      function clearError(e) {
        const field = e.target;
        field.style.borderColor = "#e5e7eb";
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Clean up any existing validation logs
        const existingLogs = document.querySelectorAll(".validation-logs");
        existingLogs.forEach((log) => log.remove());

        loadTemplates();
      });

      // Toast Notification System
      function showToast(type, title, message, duration = 5000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        const toastId = "toast-" + Date.now();

        toast.id = toastId;
        toast.className = `toast ${type}`;

        const icons = {
          success: "✓",
          error: "✕",
          warning: "⚠",
          info: "ℹ",
        };

        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || "ℹ"}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="removeToast('${toastId}')">×</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => {
          toast.classList.add("show");
        }, 10);

        // Auto remove after duration
        if (duration > 0) {
          setTimeout(() => {
            removeToast(toastId);
          }, duration);
        }

        return toastId;
      }

      function removeToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
          toast.classList.remove("show");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }
      }

      function clearAllToasts() {
        const container = document.getElementById("toast-container");
        container.innerHTML = "";
      }

      // Replace all alert() calls with toast notifications
      function showSuccessToast(message) {
        showToast("success", "Success!", message);
      }

      function showErrorToast(message) {
        showToast("error", "Error!", message);
      }

      function showWarningToast(message) {
        showToast("warning", "Warning!", message);
      }

      function showInfoToast(message) {
        showToast("info", "Info", message);
      }

      // Custom Confirmation Dialog
      const confirmationCallbacks = new Map();

      function showConfirmDialog(title, message, onConfirm, onCancel = null) {
        const container = document.getElementById("toast-container");
        const dialog = document.createElement("div");
        const dialogId = "confirm-" + Date.now();

        dialog.id = dialogId;
        dialog.className = "toast warning";
        dialog.style.minWidth = "400px";
        dialog.style.maxWidth = "500px";

        dialog.innerHTML = `
          <div class="toast-icon">⚠</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
              <button onclick="confirmAction('${dialogId}', true)" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                transition: background 0.2s ease;
              " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                Confirm
              </button>
              <button onclick="confirmAction('${dialogId}', false)" style="
                background: #6b7280;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                transition: background 0.2s ease;
              " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                Cancel
              </button>
            </div>
          </div>
          <button class="toast-close" onclick="confirmAction('${dialogId}', false)">×</button>
        `;

        container.appendChild(dialog);

        // Store callbacks in global map
        confirmationCallbacks.set(dialogId, { onConfirm, onCancel });

        // Trigger animation
        setTimeout(() => {
          dialog.classList.add("show");
        }, 10);

        return dialogId;
      }

      function confirmAction(dialogId, confirmed) {
        const dialog = document.getElementById(dialogId);
        if (dialog) {
          dialog.classList.remove("show");
          setTimeout(() => {
            if (dialog.parentNode) {
              dialog.parentNode.removeChild(dialog);
            }
          }, 300);

          // Get callbacks from global map
          const callbacks = confirmationCallbacks.get(dialogId);
          if (callbacks) {
            if (confirmed && callbacks.onConfirm) {
              try {
                callbacks.onConfirm();
              } catch (e) {
                console.error("Error executing confirmation callback:", e);
              }
            } else if (!confirmed && callbacks.onCancel) {
              try {
                callbacks.onCancel();
              } catch (e) {
                console.error("Error executing cancel callback:", e);
              }
            }
            // Clean up callbacks
            confirmationCallbacks.delete(dialogId);
          }
        }
      }

      // Template form handling
      const templateForm = document.getElementById("templateForm");
      const uploadTemplateBtn = document.getElementById("uploadTemplateBtn");
      const uploadTemplateBtnText =
        uploadTemplateBtn.querySelector(".btn-text");
      const uploadTemplateLoading = uploadTemplateBtn.querySelector(".loading");

      templateForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Show loading state
        uploadTemplateBtn.disabled = true;
        uploadTemplateBtnText.style.display = "none";
        uploadTemplateLoading.style.display = "flex";

        try {
          const formData = new FormData(templateForm);

          const response = await fetch(
            "http://localhost:3001/upload-template",
            {
              method: "POST",
              body: formData,
            }
          );

          const data = await response.json();

          if (response.ok) {
            showTemplateResult(
              "success",
              "Template Uploaded Successfully!",
              data
            );
            showSuccessToast("Template uploaded successfully!");
            templateForm.reset();
            selectedTemplateFile.style.display = "none";
            templateFileLabel.textContent = "Choose .wpress file or drag here";

            // Refresh templates list
            loadTemplatesForManagement();
          } else {
            showTemplateResult("error", "Failed to Upload Template", data);
          }
        } catch (error) {
          console.error("Template upload error:", error);
          showTemplateResult("error", "Upload Error", {
            error: "Network error occurred. Please check your connection.",
          });
        } finally {
          // Reset button state
          uploadTemplateBtn.disabled = false;
          uploadTemplateBtnText.style.display = "flex";
          uploadTemplateLoading.style.display = "none";
        }
      });

      function showTemplateResult(type, title, data) {
        const templateResult = document.getElementById("templateResult");
        templateResult.className = `result ${type}`;
        templateResult.innerHTML = `
          <h3><i class="fas fa-${
            type === "success" ? "check-circle" : "exclamation-circle"
          }"></i> ${title}</h3>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        templateResult.style.display = "block";
        templateResult.scrollIntoView({ behavior: "smooth" });
      }

      // Load templates for management tab
      async function loadTemplatesForManagement() {
        try {
          const response = await fetch("http://localhost:3001/templates");
          const data = await response.json();

          const templatesList = document.getElementById("templatesList");

          if (data.templates.length === 0) {
            templatesList.innerHTML =
              '<p style="text-align: center; color: #6b7280; padding: 20px;">No templates found.</p>';
            return;
          }

          templatesList.innerHTML = data.templates
            .map(
              (template) => `
            <div class="template-item">
              <div class="template-info">
                <h4>
                  ${template.type === "custom" ? "🎨" : "🌐"} ${template.name}
                  <span class="template-type ${template.type}">${
                template.type
              }</span>
                </h4>
                <p><strong>Description:</strong> ${
                  template.description || "No description available"
                }</p>
                <p><strong>Version:</strong> ${template.version || "N/A"}</p>
                ${
                  template.rating
                    ? `<p><strong>Rating:</strong> ⭐ ${template.rating} (${template.num_ratings} reviews)</p>`
                    : ""
                }
                ${
                  template.sizeFormatted
                    ? `<p><strong>Size:</strong> ${template.sizeFormatted}</p>`
                    : ""
                }
                <p><strong>Last Updated:</strong> ${new Date(
                  template.last_updated || template.modifiedAt
                ).toLocaleDateString()}</p>
              </div>
              <div class="template-actions">
                ${
                  template.type === "custom"
                    ? `
                  <button class="btn btn-danger" onclick="deleteTemplate('${template.id}')">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                `
                    : ""
                }
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading templates:", error);
        }
      }

      // Delete template
      async function deleteTemplate(id) {
        showConfirmDialog(
          "Delete Template",
          "Are you sure you want to delete this template?",
          () => performDeleteTemplate(id)
        );
      }

      async function performDeleteTemplate(id) {
        try {
          const response = await fetch(
            `http://localhost:3001/templates/${id}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            showSuccessToast("Template deleted successfully!");
            loadTemplatesForManagement(); // Refresh the templates list
            loadTemplates(); // Refresh deploy form templates
          } else {
            showErrorToast("Failed to delete template");
          }
        } catch (error) {
          console.error("Error deleting template:", error);
          showErrorToast("Error deleting template");
        }
      }

      // === Next Steps Section ===
      function showNextSteps({
        domain,
        manualDbSetup,
        dbInstructions,
        nextStep,
      }) {
        let nextStepsDiv = document.getElementById("nextSteps");
        if (!nextStepsDiv) {
          nextStepsDiv = document.createElement("div");
          nextStepsDiv.id = "nextSteps";
          nextStepsDiv.style.marginTop = "30px";
          nextStepsDiv.style.padding = "24px";
          nextStepsDiv.style.background = "#f8fafc";
          nextStepsDiv.style.border = "1px solid #e5e7eb";
          nextStepsDiv.style.borderRadius = "12px";
          nextStepsDiv.style.textAlign = "center";
          const deploymentTab = document.getElementById("deploy-tab");
          deploymentTab.appendChild(nextStepsDiv);
        }
        nextStepsDiv.innerHTML = "";

        if (manualDbSetup) {
          nextStepsDiv.innerHTML = `
            <h3 style="color:#d97706;"><i class="fas fa-database"></i> Manual Database Setup Required</h3>
            <div style="text-align:left; margin: 20px auto; max-width: 500px; background: #fffbe6; border: 1px solid #fde68a; border-radius: 8px; padding: 18px; color: #92400e;">
              <div style="white-space: pre-wrap;">${
                renderDbInstructions(dbInstructions) ||
                "Please follow the instructions above to create your database and user in cPanel."
              }</div>
            </div>
            <button id="confirmDbBtn" class="btn btn-primary" style="margin-top:18px;">
              <i class="fas fa-check"></i> I have created the database, continue
            </button>
          `;
          document.getElementById("confirmDbBtn").onclick = function () {
            showNextSteps({ domain, manualDbSetup: false, nextStep });
          };
        } else {
          // Show install.php link
          const installUrl = nextStep || `https://${domain}/install.php`;
          nextStepsDiv.innerHTML = `
            <h3 style="color:#059669;"><i class="fas fa-play-circle"></i> Proceed to WordPress Installation</h3>
            <p>Please create the database manually in cPanel, then visit the link below to complete WordPress installation:</p>
            <a href="https://${domain}/install.php" target="_blank" class="btn btn-primary" style="margin-top:18px; font-size:1.1rem;">
              <i class="fas fa-link"></i> Open install.php
            </a>
            <div style="margin-top:12px; color:#6b7280; font-size:0.95rem;">This will finalize your WordPress site setup.</div>
          `;
        }
        nextStepsDiv.scrollIntoView({ behavior: "smooth" });
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderDbInstructions(dbInstructions) {
        if (typeof dbInstructions === "string")
          return escapeHtml(dbInstructions);
        if (Array.isArray(dbInstructions))
          return dbInstructions.map(escapeHtml).join("<br>");
        // If it's an object, format as HTML
        let html = "<ul>";
        for (const key in dbInstructions) {
          html += `<li><strong>${escapeHtml(key)}:</strong> ${escapeHtml(
            dbInstructions[key]
          )}</li>`;
        }
        html += "</ul>";
        return html;
      }
    </script>
  </body>
</html>
